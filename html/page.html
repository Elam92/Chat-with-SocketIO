<!doctype html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="styles.css">
    </head>
    <body>
        <div id="container">
          <div id="chat"></div>
          <div id="chat-rooms"></div>
        </div>
        <div id="input-area">
          <input type="text" id="name" placeholder="your name" />
          <input type="text" id="input" class="input-box" disabled="disabled" />
          <select id="users">
            <option value="">all</option>
          </select>
        </div>
        <script src="/socket.io/socket.io.js"></script>
    <script>
      window.onload = function() {
        var Chat = (function() {

          var addEventListener = function(obj, evt, fnc) {
              if (obj.addEventListener) { // W3C model
                  obj.addEventListener(evt, fnc, false);
                  return true;
              } else if (obj.attachEvent) { // Microsoft model
                  return obj.attachEvent('on' + evt, fnc);
              }
          }
          var getRandomColour = function() {
              var letters = '0123456789ABCDEF'.split('');
              var colour = '#';
              for (var i = 0; i < 6; i++ ) {
                  colour += letters[Math.round(Math.random() * 15)];
              }
              return colour;
          }

          var socket = io.connect('http://localhost:3000');
          var chat = document.querySelector("#chat");
          var chatRooms = document.querySelector("#chat-rooms");
          var input = document.querySelector("#input");
          var name = document.querySelector("#name");
          var users = document.querySelector("#users");
          var selectedUser = null;
          var id = null;
          var colour = getRandomColour();
          var oldName = "";

          // Send message to server.
          var send = function(message) {
            var userName = name.value === '' ? '' : '<strong>' + name.value + ': </strong>';
            socket.emit('send', {
              message: '<span style="color:' + colour + '">' + userName + message + '</span>',
              userName: name.value,
              toUser: users.value,
              fromUser: id
            });
          }

          // Display message from server.
          var display = function(message) {
            chat.innerHTML = chat.innerHTML + message + '<br />';
            chat.scrollTop = chat.scrollHeight;
          }

          // Send messages to others.
          addEventListener(input, "keydown", function(e) {
            // The Enter Key.
            if(e.keyCode === 13) {
              send(input.value);
              input.value = "";
            }
          });

          // Save who you are talking to whenever user list gets refreshed.
          addEventListener(users, "change", function(e) {
            selectedUser = users.value;
          });

          // Send message to everyone in room that you updated your name.
          addEventListener(name, "change", function(e) {
            socket.emit('change-name', { oldName: oldName, newName: name.value, colour: colour});
            oldName = name.value;
          });

          socket.on('welcome', function(data) {
            id = data.id;
            name.value = 'Guest' + data.numID;
            oldName = name.value;
            display(data.message);
            input.removeAttribute("disabled");
            input.focus();
          })
          .on('receive', function(data) {
            display(data.message);
          })
          .on('users', function(data) {
            var html = '<option value="">all</option>';
            for(var i = 0; i < data.length; i++) {
              var user = data[i];
              if(id != user.id) {
                var userName = user.name ? user.name : 'user' + (i + 1);
                var selected = user.id === selectedUser ? ' selected="selected"': '';
                html += '<option value="' + user.id + '"' + selected + '>' + userName + '</option>';
              }
            }
            users.innerHTML = html;
          })
          .on('rooms', function(data) {
            var html = "";
            for(var i = 0; i < data.length; i++) {
              html += '<p>' + data[i] + '</p>';
            }
            chatRooms.innerHTML = html;
          })
          .on('update-name', function(data) {
            display('<span style="color:' + data.colour + '">' + data.oldName + ' has changed their name to ' + data.newName + '</span>');
          });
        })();
      }
    </script>
    </body>
</html>